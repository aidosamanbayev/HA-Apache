provider "openstack" {
  version   = "1.45.0"
  auth_url  = "https://auth.pscloud.io/v3/"
  username  = "aidos.amanbayev@gmail.com"
  password  = "Fqljc$14"
  tenant_id = "sigma-neptunium"
  region    = "kz-ala-1"
}

resource "openstack_compute_instance_v2" "vm" {
  count         = 5
  name          = "vm-${count.index + 1}"
  image_id      = "centos-image-id"
  flavor_id     = "flavor-id"
  key_pair      = "your-key-pair"

  network {
    uuid = "network-uuid"
  }

  lifecycle {
    ignore_changes = [ "floating_ip" ]
  }

  connection {
    type        = "ssh"
    user        = "centos"
    private_key = file("~/.ssh/id_rsa")
  }

  provisioner "remote-exec" {
    inline = [
      "sudo yum install -y ansible",
    ]
    when = "create"
  }
}

resource "openstack_compute_floatingip_associate_v2" "floating_ip" {
  instance_id = openstack_compute_instance_v2.vm[0].id
  floating_ip = "YOUR_FLOATING_IP"
}
